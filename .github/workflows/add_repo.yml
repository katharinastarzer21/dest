name: Add Repository to Gallery

on:
  issues:
    types: [opened, labeled]

jobs:
  process-request:
    if: contains(github.event.issue.labels.*.name, 'add-repo')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v3

    - name: Install PyYAML
      run: pip install pyyaml

    - name: Extract and Update notebook_gallery.yaml
      run: |
        echo "Reading issue body..."
        ISSUE_BODY="${{ github.event.issue.body }}"

        echo "$ISSUE_BODY" > issue_body.txt

        # Extraktion in Python
        python3 <<EOF
        import yaml
        import re

        # Lade YAML
        with open('notebook_gallery.yaml') as f:
            gallery = yaml.safe_load(f)

        # Lese Issue Body
        with open('issue_body.txt') as f:
            body = f.read()

        def extract_value(label):
            pattern = rf"{label}\*\*\n(.*?)\n"
            match = re.search(pattern, body)
            return match.group(1).strip() if match else ""

        repo_url = extract_value("Repository URL")
        title = extract_value("Cookbook Title")
        description = extract_value("Short Description")
        thumbnail = extract_value("Thumbnail Image URL")
        root_path = extract_value("Root Path Name")

        print(f"Parsed: {repo_url}, {title}, {description}, {thumbnail}, {root_path}")

        gallery['domains'][root_path] = {
            'title': title,
            'branch': 'main',
            'root_path': root_path,
            'description': description,
            'thumbnail': thumbnail,
            'url': f"https://destination-earth.github.io/DestinE-DataLake-Lab/{root_path}/README.html"
        }

        with open('notebook_gallery.yaml', 'w') as f:
            yaml.dump(gallery, f, sort_keys=False)
        EOF

    - name: Commit updated YAML
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'actions@github.com'
        git add notebook_gallery.yaml
        git commit -m "Added new cookbook via issue automation"
        git push origin main
