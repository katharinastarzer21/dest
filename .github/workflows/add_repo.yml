name: Add Repository to Gallery

on:
  issues:
    types: [opened, labeled]

jobs:
  process-request:
    if: contains(github.event.issue.labels.*.name, 'add-repo')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v3

    - name: Install PyYAML
      run: pip install pyyaml

    - name: Save Issue Body to File
      run: |
        echo "${{ github.event.issue.body }}" > issue_body.txt

    - name: Parse and Update YAML
      run: |
        python3 parse_issue.py

    - name: Clone new Cookbook Repository
      run: |
          git clone $REPO_URL cookbooks/$ROOT_PATH

    - name: Install Sphinx
      run: pip install sphinx
  
    - name: Build HTML from Cookbook with Sphinx
      run: |
          cd cookbooks/$ROOT_PATH
          sphinx-build -b html . ../../_build/html/$ROOT_PATH
  
    - name: Commit updated YAML
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'actions@github.com'
        git add notebook_gallery.yaml
        git commit -m "Added new cookbook via issue automation"
        git push origin main
