name: Add Repository to Gallery

on:
  issues:
    types: [opened, labeled]

jobs:
  process-request:
    if: contains(github.event.issue.labels.*.name, 'add-repo')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v3

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Save Issue Body to File
        run: |
          echo "${{ github.event.issue.body }}" > issue_body.txt

      - name: Parse Issue and Export Variables
        id: vars
        run: |
          python3 parse_issue.py  # setzt $REPO_URL und $ROOT_PATH als Umgebungsvariablen
          echo "REPO_URL=$(yq '.repo_url' issue_body.txt)" >> $GITHUB_ENV
          echo "ROOT_PATH=$(yq '.root_path' issue_body.txt)" >> $GITHUB_ENV

      - name: Clone new Cookbook Repository
        run: git clone $REPO_URL $ROOT_PATH

      - name: Install Sphinx and Plugins
        run: |
          pip install sphinx myst-parser nbsphinx sphinx-book-theme \
                      sphinx-design myst-nb pyyaml ghp-import

      - name: Build Cookbook HTML into docs/$ROOT_PATH
        run: |
          sphinx-build -b html $ROOT_PATH docs/$ROOT_PATH -c .

      - name: Rename README.html to index.html (for GitHub Pages)
        run: |
          if [ -f docs/$ROOT_PATH/README.html ]; then
            mv docs/$ROOT_PATH/README.html docs/$ROOT_PATH/index.html
          fi

      - name: Add .nojekyll to disable Jekyll
        run: |
          touch docs/.nojekyll

      - name: Commit and Push Built HTML and Gallery Update
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add -f docs/$ROOT_PATH
          git add -f docs/.nojekyll
          git add -f notebook_gallery.yaml
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Added new cookbook: $ROOT_PATH"
            git push origin main
          fi
