name: Add Repository to Gallery

on:
  issues:
    types: [opened, labeled]

jobs:
  process-request:
    if: contains(github.event.issue.labels.*.name, 'add-repo')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v3

    - name: Install PyYAML
      run: pip install pyyaml

    - name: Extract and Update notebook_gallery.yaml (Fix 2)
      run: |
        echo "Reading issue body..."
        ISSUE_BODY="${{ github.event.issue.body }}"
        echo "$ISSUE_BODY" > issue_body.txt
        echo "ISSUE_BODY:"
        cat issue_body.txt

        python3 <<EOF
        import yaml

        # Lade YAML
        with open('notebook_gallery.yaml') as f:
            gallery = yaml.safe_load(f)

        # Lese Issue Body
        with open('issue_body.txt') as f:
            body = f.read()

        print("Full Issue Body:")
        print(body)

        # Zeilenweise parsen ohne Regex
        fields = {
            "Repository URL": "",
            "Cookbook Title": "",
            "Short Description": "",
            "Thumbnail Image URL": "",
            "Root Path Name": ""
        }

        lines = body.splitlines()

        current_label = None
        for line in lines:
            line = line.strip()
            if line in fields:
                current_label = line
            elif current_label and line:
                fields[current_label] = line
                current_label = None

        repo_url = fields["Repository URL"]
        title = fields["Cookbook Title"]
        description = fields["Short Description"]
        thumbnail = fields["Thumbnail Image URL"]
        root_path = fields["Root Path Name"]

        print(f"Repo URL: {repo_url}")
        print(f"Title: {title}")
        print(f"Description: {description}")
        print(f"Thumbnail: {thumbnail}")
        print(f"Root Path: {root_path}")

        if not root_path:
            raise ValueError("Root Path konnte nicht extrahiert werden â€“ Abbruch.")

        gallery['domains'][root_path] = {
            'title': title,
            'branch': 'main',
            'root_path': root_path,
            'description': description,
            'thumbnail': thumbnail,
            'url': f"https://destination-earth.github.io/DestinE-DataLake-Lab/{root_path}/README.html"
        }

        with open('notebook_gallery.yaml', 'w') as f:
            yaml.dump(gallery, f, sort_keys=False)

        EOF

    - name: Commit updated YAML
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'actions@github.com'
        git add notebook_gallery.yaml
        git commit -m "Added new cookbook via issue automation"
        git push origin main
