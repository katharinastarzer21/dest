
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>STACK service - Python Client Dask &#8212; DEDL Notebook Gallery</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'STACK_test/STACK-Python-Client-Dask';</script>
    <link rel="icon" href="https://hda.data.destination-earth.eu/ui/images/favicon.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="https://destination-earth.eu/">
  
  
  
  
  
    
    
      
    
    
    <img src="https://hda.data.destination-earth.eu/ui/images/destination_earth_logo_W.svg" class="logo__image only-light" alt="Destination Earth"/>
    <script>document.write(`<img src="https://hda.data.destination-earth.eu/ui/images/destination_earth_logo_W.svg" class="logo__image only-dark" alt="Destination Earth"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/destination-earth" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/destination-earth" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">STACK...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="" src="https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/img/DestinE-banner.jpg?raw=true" /></p>
<p><strong>Licence</strong>: MIT <br></p>
<a class="reference internal image-reference" href="https://docs.dask.org/en/latest/_images/dask_horizontal.svg"><img alt="Dask logo" class="align-right" src="https://docs.dask.org/en/latest/_images/dask_horizontal.svg" style="width: 25%;" />
</a>
<section class="tex2jax_ignore mathjax_ignore" id="stack-service-python-client-dask">
<h1>STACK service - Python Client Dask<a class="headerlink" href="#stack-service-python-client-dask" title="Link to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="multi-cloud-processing-with-dask">
<h1>Multi-cloud processing with Dask<a class="headerlink" href="#multi-cloud-processing-with-dask" title="Link to this heading">#</a></h1>
<div class="alert-info">
    <h4>Overview</h4>
    <h5>Content</h5>
    <li>DestinE Data Lake (DEDL) Stack Client</li>
    <li>Making use of clients context manager</li>
    <li>Use Case: Pakistan Flood 2022</li>
    <h5>Duration: 15 min.</h5>
</div>
</br>
<div class="alert-warning">
Please make sure Python DEDL kernel is used.
</div>
<p>DestinE Data Lake utilises a deployment of <a class="reference external" href="https://gateway.dask.org/">Dask Gateway</a> on each location (bridge) in the data lake. Dask Gateway provides a secure, multi-tenant server for managing Dask clusters. It allows users to launch and use Dask clusters in a shared, centrally managed cluster environment, without requiring users to have direct access to the underlying cluster backend (e.g. Kubernetes, Hadoop/YARN, HPC Job queues, etc…).</p>
<p>Dask Gateway exposes a REST API to spawn clusters on demand. The overall architecture of Dask Gateway is depicted hereafter.</p>
<a class="reference internal image-reference" href="https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/STACK/img/DEDL_Dask_multicloud.png?raw=true"><img alt="https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/STACK/img/DEDL_Dask_multicloud.png?raw=true" src="https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/STACK/img/DEDL_Dask_multicloud.png?raw=true" style="width: 60%;" />
</a>
<section id="dedl-dask-gateway">
<h2>DEDL Dask Gateway<a class="headerlink" href="#dedl-dask-gateway" title="Link to this heading">#</a></h2>
<p><strong>Central Site</strong></p>
<ul class="simple">
<li><p>address: http://dask.central.data.destination-earth.eu</p></li>
<li><p>proxy_address: tcp://dask.central.data.destination-earth.eu:80</p></li>
</ul>
<p><strong>LUMI Bridge</strong></p>
<ul class="simple">
<li><p>address: http://dask.lumi.data.destination-earth.eu</p></li>
<li><p>proxy_address: tcp://dask.lumi.data.destination-earth.eu:80</p></li>
</ul>
<p>Only authenticated access is granted to the DEDL STACK service Dask, therefore a helper class to authenticate a user against the DESP identity management system is implemented. The users password is directly handed over to the request object and is not permanently stored.</p>
<p>In the following, please enter your DESP username and password. Again, the password will only be saved for the duration of this user session and will be remove as soon as the notebook/kernel is closed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dask_gateway.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">GatewayAuth</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">getpass</span><span class="w"> </span><span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">destinelab</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthHandler</span> <span class="k">as</span> <span class="n">DESP_AuthHandler</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DESPAuth</span><span class="p">(</span><span class="n">GatewayAuth</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_handler</span> <span class="o">=</span> <span class="n">DESP_AuthHandler</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">getpass</span><span class="p">(</span><span class="s2">&quot;Please input your DESP password: &quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_handler</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">headers</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rich.prompt</span><span class="w"> </span><span class="kn">import</span> <span class="n">Prompt</span>
<span class="n">myAuth</span> <span class="o">=</span> <span class="n">DESPAuth</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">Prompt</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Username&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Username: </pre>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> christoph.reimer
Please input your DESP password:  ········
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response code: 200
</pre></div>
</div>
</div>
</div>
</section>
<section id="destine-data-lake-dedl-stack-client">
<h2>DestinE Data Lake (DEDL) Stack Client<a class="headerlink" href="#destine-data-lake-dedl-stack-client" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/destination-earth/DestinE_EUMETSAT_DEDL_Stack_Client">DEDL Stack Client is a Python</a> library to facilitate the use of Stack Service Dask. The main objective is to provide an abstraction layer to interact with the various clusters on each DEDL bridge. Computations can be directed to the different Dask clusters by making use of a context manager as given in the following.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dedl_stack_client.dask</span><span class="w"> </span><span class="kn">import</span> <span class="n">DaskMultiCluster</span>

<span class="n">myDEDLClusters</span> <span class="o">=</span> <span class="n">DaskMultiCluster</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">myAuth</span><span class="p">)</span>
<span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">new_cluster</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Create new cluster for Central Site
Create new cluster for LUMI Bridge
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">get_cluster_url</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://dask.central.data.destination-earth.eu/clusters/dask-gateway.203d0155443945c986a35b0488db7ebb/status
http://dask.lumi.data.destination-earth.eu/clusters/dask-gateway.9010455c0c8a44df9a52e15003252889/status
</pre></div>
</div>
</div>
</div>
<p>We can again showcase the execution of standard Python functions on the remote clusters.
In the following we will make use of <code class="docutils literal notranslate"><span class="pre">dask.futures</span></code>, non-blocking distributed calculations, utilising the <code class="docutils literal notranslate"><span class="pre">map()</span></code> method for task distribution. Detailed information about <code class="docutils literal notranslate"><span class="pre">dask.futures</span></code> can be found on the <a class="reference external" href="https://docs.dask.org/en/stable/futures.html">Dask documention</a>.</p>
<p>This approach allows for embarrassingly parallel task scheduling, which is very similar to Function as a Service capabilities.</p>
<img alt="https://docs.dask.org/en/latest/_images/map-reduce-task-scheduling.svg" src="https://docs.dask.org/en/latest/_images/map-reduce-task-scheduling.svg" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span> <span class="k">as</span> <span class="n">wait</span>

<span class="k">def</span><span class="w"> </span><span class="nf">apply_myfunc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>We want to run <code class="docutils literal notranslate"><span class="pre">apply_myfunc()</span></code> on <strong>Central Site</strong> and wait for all results to be ready. <code class="docutils literal notranslate"><span class="pre">my_filelist_central</span></code> represents a filelist to be processed by <code class="docutils literal notranslate"><span class="pre">apply_myfunc()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_filelist_central</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="k">with</span> <span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">as_current</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;central&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myclient</span><span class="p">:</span>
    <span class="n">central_future</span> <span class="o">=</span> <span class="n">myclient</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_myfunc</span><span class="p">,</span> <span class="n">my_filelist_central</span><span class="p">)</span>
    <span class="n">results_central</span> <span class="o">=</span> <span class="n">myclient</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">central_future</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_central</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
</pre></div>
</div>
</div>
</div>
<p>Run computation at <strong>LUMI bridge</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_filelist_lumi</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="k">with</span> <span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">as_current</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;lumi&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myclient</span><span class="p">:</span>
    <span class="n">lumi_future</span> <span class="o">=</span> <span class="n">myclient</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">apply_myfunc</span><span class="p">,</span> <span class="n">my_filelist_lumi</span><span class="p">)</span>
    <span class="n">results_lumi</span> <span class="o">=</span> <span class="n">myclient</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">lumi_future</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_lumi</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1,
 2,
 3,
 4,
 5,
 6,
 7,
 8,
 9,
 10,
 11,
 12,
 13,
 14,
 15,
 16,
 17,
 18,
 19,
 20,
 21,
 22,
 23,
 24,
 25,
 26,
 27,
 28,
 29,
 30,
 31,
 32]
</pre></div>
</div>
</div>
</div>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Python libraries use in the local environment need to match, same version, with those available in the Dask Cluster. If this is not the case, you will get a warning, code might work but not guaranteed.</p></li>
<li><p>No direct data exchange between Dask Workers across cloud locations possible. Each location acts as atmoic unit, however data can be easily exchanged via storage services such as S3.</p></li>
</ul>
</section>
<section id="use-case-example-pakistan-flood-2022">
<h2>Use Case example: Pakistan Flood 2022<a class="headerlink" href="#use-case-example-pakistan-flood-2022" title="Link to this heading">#</a></h2>
<p><strong>The complete use case is available on GitHub via https://github.com/destination-earth/DestinE_EUMETSAT_PakistanFlood_2022.</strong></p>
<p>The use case demonstrates the multi-cloud capabilities of DEDL following the paradigm of data proximate computing. Data of the <strong>Global Flood Monitoring (GFM)</strong> service as well as <strong>Climate DT outputs, simulated by utilising ERA5 data</strong> have been use for flood risk assessment.</p>
<a class="reference internal image-reference" href="https://github.com/destination-earth/DestinE_EUMETSAT_PakistanFlood_2022/blob/main/img/DEDL_FloodUC_dataflow.png?raw=true"><img alt="https://github.com/destination-earth/DestinE_EUMETSAT_PakistanFlood_2022/blob/main/img/DEDL_FloodUC_dataflow.png?raw=true" src="https://github.com/destination-earth/DestinE_EUMETSAT_PakistanFlood_2022/blob/main/img/DEDL_FloodUC_dataflow.png?raw=true" style="width: 35%;" />
</a>
<p>Data is stored as datacubes (zarr format) at Central Site and at LUMI bridge in object storage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">s3fs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">s3fs_central</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span>
    <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;endpoint_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://s3.central.data.destination-earth.eu&quot;</span><span class="p">})</span>

<span class="n">s3fs_lumi</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span>
    <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;endpoint_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://s3.lumi.data.destination-earth.eu&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>We can list the data available at Central Site.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s3fs_central</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s2">&quot;increment1-testdata&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;increment1-testdata/2022-08-30.zarr&#39;, &#39;increment1-testdata/built_data.zarr&#39;]
</pre></div>
</div>
</div>
</div>
<p>Read data stored in S3 bucket at Central Site. The data we want to read is a single Zarr data store representing the GFM flood data over Pakistan for 2022-08-30.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flood_map</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">store</span><span class="o">=</span><span class="n">s3fs</span><span class="o">.</span><span class="n">S3Map</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;increment1-testdata/2022-08-30.zarr&quot;</span><span class="p">,</span> <span class="n">s3</span><span class="o">=</span><span class="n">s3fs_central</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                         <span class="n">decode_coords</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,)[</span><span class="s2">&quot;flood&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1">#flood_map</span>
</pre></div>
</div>
</div>
</div>
<p>We now want to run simple computation and compute the flooded area for the this day in August 2022.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flooded_area_</span> <span class="o">=</span> <span class="n">flood_map</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">20</span><span class="o">*</span><span class="mi">20</span><span class="o">/</span><span class="mf">1000.</span>
<span class="c1">#flooded_area_</span>
</pre></div>
</div>
</div>
</div>
<p>So far we haven’t computed anything, so lets do the computation now on the Dask cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rich.console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.prompt</span><span class="w"> </span><span class="kn">import</span> <span class="n">Prompt</span>
<span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

<span class="n">flooded_area</span> <span class="o">=</span> <span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">flooded_area_</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flooded area: </span><span class="si">{</span><span class="n">flooded_area</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2"> km2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Flooded area: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18991614.0</span> km2
</pre>
</div></div>
</div>
<p><strong>How was that processing routed to Dask Gateway at Central Site</strong>?</p>
<p><code class="docutils literal notranslate"><span class="pre">myDEDLClusters.compute(flooded_area_,</span> <span class="pre">sync=True)</span></code> checks for annotations (attributes) of array and maps that to available Dask Clusters.</p>
<p>Preprocess GFM data at <strong>Central Site</strong> for visualiation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_dataset</span><span class="p">(</span><span class="n">data_array</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">//</span> <span class="n">data_array</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]</span>
    <span class="n">coarsened</span> <span class="o">=</span> <span class="n">data_array</span><span class="o">.</span><span class="n">coarsen</span><span class="p">({</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">steps</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">steps</span><span class="p">},</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;trim&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">coarsened</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">coarsened</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">coarsened</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_array</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flood_prep_</span> <span class="o">=</span> <span class="n">preprocess_dataset</span><span class="p">(</span><span class="n">flood_map</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">flood_prep</span> <span class="o">=</span> <span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">flood_prep_</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">flood_prep</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="s2">&quot;epsg:4326&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">flood_prep</span> <span class="o">=</span> <span class="n">flood_prep</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EPSG:3857&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Visualise flood data on map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">leafmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">attr</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Extent</span><span class="p">:</span>
    <span class="n">min_x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">min_y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">crs</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">min_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">min_x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">]))</span>


<span class="n">roi_extent</span> <span class="o">=</span> <span class="n">Extent</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">roi_extent</span><span class="o">.</span><span class="n">get_center</span><span class="p">(),</span>
                <span class="n">zoom</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">add_raster</span><span class="p">(</span><span class="n">flood_prep</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;Flood&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

<span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8b9c7249181848be8d4dd6f40304ec7b", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>Read data stored in S3 bucket at LUMI bridge (Finland). Data we want to read is a datacube generated from ERA-5 representing predicted rainfall data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rainfall</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">store</span><span class="o">=</span><span class="n">s3fs</span><span class="o">.</span><span class="n">S3Map</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;increment1-testdata/predicted_rainfall.zarr&quot;</span><span class="p">,</span>
                                         <span class="n">s3</span><span class="o">=</span><span class="n">s3fs_lumi</span><span class="p">,</span>
                                         <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                        <span class="n">decode_coords</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,)[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;lumi&quot;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And again run the computation close to the data, therefore at <strong>LUMI bridge</strong>.</p>
<p>First we compute the accumulated rainfall over Pakistan.
Secondly we compute the average rainfall for August 2022 (monthly mean) at global scale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">accum_rain_predictions</span><span class="p">(</span><span class="n">rain_data</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
    <span class="n">rain_</span> <span class="o">=</span> <span class="n">rain_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">),</span>
                          <span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">max_y</span><span class="p">,</span> <span class="n">extent</span><span class="o">.</span><span class="n">min_y</span><span class="p">),</span>
                          <span class="n">longitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">min_x</span><span class="p">,</span> <span class="n">extent</span><span class="o">.</span><span class="n">max_x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rain_</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>

<span class="c1"># compute accumulated rainfall over Pakistan</span>
<span class="n">acc_rain_</span> <span class="o">=</span> <span class="n">accum_rain_predictions</span><span class="p">(</span><span class="n">rainfall</span><span class="p">,</span> <span class="n">startdate</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                                                  <span class="n">enddate</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                                                  <span class="n">extent</span><span class="o">=</span><span class="n">roi_extent</span><span class="p">)</span>
<span class="n">acc_rain_</span> <span class="o">=</span> <span class="n">acc_rain_</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;y&quot;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acc_rain</span> <span class="o">=</span> <span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">acc_rain_</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">acc_rain_reproject</span><span class="p">(</span><span class="n">rain</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resampling</span>
    <span class="n">rain</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_nodata</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rain</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rain</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">bilinear</span><span class="p">)</span>

<span class="n">acc_rain</span> <span class="o">=</span> <span class="n">acc_rain_reproject</span><span class="p">(</span><span class="n">acc_rain</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Visualise forecast data provided by the Digital Twin which could have been used for flood risk assessment or even alerting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_dim_len</span> <span class="o">=</span> <span class="n">acc_rain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_dim_len</span><span class="p">):</span>
    <span class="n">fpath_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s2">.tif&quot;</span>
    <span class="n">acc_rain</span><span class="p">[</span><span class="n">day</span><span class="p">,:]</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">fpath_str</span><span class="p">,</span>
                                  <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;COG&quot;</span><span class="p">,</span>
                                  <span class="n">overview_count</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">leafmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">localtileserver</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_leaflet_tile_layer</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">leafmap</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">roi_extent</span><span class="o">.</span><span class="n">get_center</span><span class="p">(),</span>
                <span class="n">zoom</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>

<span class="n">layer_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">date_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime_as_string</span><span class="p">(</span><span class="n">acc_rain</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_dim_len</span><span class="p">):</span>
    <span class="n">layer_dict</span><span class="p">[</span><span class="n">date_vals</span><span class="p">[</span><span class="n">day</span><span class="p">]]</span><span class="o">=</span> <span class="n">get_leaflet_tile_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">,</span>
                                                       <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
                                                       <span class="n">indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                       <span class="n">nodata</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                                       <span class="n">vmin</span><span class="o">=</span><span class="n">acc_rain</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                       <span class="n">vmax</span><span class="o">=</span><span class="n">acc_rain</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                       <span class="n">opacity</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

<span class="n">m</span><span class="o">.</span><span class="n">add_local_tile</span><span class="p">(</span><span class="n">flood_prep</span><span class="p">,</span>
                 <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
                 <span class="n">nodata</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">add_time_slider</span><span class="p">(</span><span class="n">layer_dict</span><span class="p">,</span>
                  <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;Accumluated Rainfall&quot;</span><span class="p">,</span>
                  <span class="n">time_interval</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myDEDLClusters</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">STACK service - Python Client Dask</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-cloud-processing-with-dask">Multi-cloud processing with Dask</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dedl-dask-gateway">DEDL Dask Gateway</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#destine-data-lake-dedl-stack-client">DestinE Data Lake (DEDL) Stack Client</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-example-pakistan-flood-2022">Use Case example: Pakistan Flood 2022</a></li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/STACK_test/STACK-Python-Client-Dask.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Destination Earth Data Lake.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>